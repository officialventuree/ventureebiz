rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * VENTUREE BIZ SAAS SECURITY RULES
     * 
     * Core Philosophy:
     * This ruleset implements a multi-tenant SaaS security model. Access is primarily governed by a 
     * user's role (PlatformAdmin, CompanyOwner, or CompanyViewer) and their association with a specific company.
     * 
     * Data Structure:
     * - Global configurations (Pricing, Modules, Currencies) are top-level and publicly readable.
     * - Platform management data (Profits, Admins) is restricted to PlatformAdmin users.
     * - Business data is nested under /companies/{companyId}.
     * 
     * Key Security Decisions:
     * 1. Authorization Independence: We denormalize 'companyOwnerUserId' into subcollections (Subscriptions, 
     *    Transactions) to allow owners to access their data without costly parent document lookups.
     * 2. Lock-out System: Access to business data for Company users is contingent on the Company status 
     *    being 'Active'. This is enforced via a helper function that performs a 'get()' on the parent Company.
     * 3. Admin Verification: We use a dedicated /platform_admins collection for highly performant 
     *    'exists()' checks to verify administrative privileges.
     * 4. Prototyping Flexibility: Logic enforces ownership and relational integrity (IDs, Owner links) 
     *    but remains flexible on general content fields to support rapid UI/UX iteration.
     */

    // --- Helper Functions ---

    /** Checks if the request is from an authenticated user. */
    function isSignedIn() {
      return request.auth != null;
    }

    /** Checks if the user is a Platform Admin using a high-performance exists check. */
    function isPlatformAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/platform_admins/$(request.auth.uid));
    }

    /** Checks if the provided UID matches the authenticated user's UID. */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /** Returns the authenticated user's document data. */
    function currentUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /** 
     * Checks if a company is currently 'Active'. 
     * Used for the platform lock-out system.
     */
    function isCompanyActive(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)).data.status == 'Active';
    }

    /** 
     * Combined check for Company Owners: Must own the document AND the company must be active 
     * (or the user is a Platform Admin who bypasses lockouts).
     */
    function canOwnerAccess(ownerId, companyId) {
      return isPlatformAdmin() || (isOwner(ownerId) && isCompanyActive(companyId));
    }

    // --- Collection Rules ---

    /**
     * @description Rules for the User collection. Users manage their own profiles.
     * @path /users/{userId}
     * @allow (get) if authenticated as {userId} or if PlatformAdmin.
     * @deny (create) if the internal 'id' field does not match the document path ID.
     * @principle Ownership and Relational Integrity.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isPlatformAdmin();
      allow list: if isPlatformAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if (isOwner(userId) || isPlatformAdmin()) && request.resource.data.id == resource.data.id;
      allow delete: if isPlatformAdmin();
    }

    /**
     * @description Tracks UIDs of Platform Admins for efficient authorization.
     * @path /platform_admins/{platformAdminId}
     * @allow (get, list, write) only for existing Platform Admins.
     * @principle DBAC (Database-Based Access Control) for administrative roles.
     */
    match /platform_admins/{platformAdminId} {
      allow get, list: if isPlatformAdmin();
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description Main Company records. Accessible by owners, viewers, and admins.
     * @path /companies/{companyId}
     * @allow (get) if PlatformAdmin, the Company Owner, or a Viewer belonging to this company.
     * @deny (write) if not a Platform Admin. (Admins manage company lifecycle).
     * @principle Structural Segregation and Path-Based Ownership.
     */
    match /companies/{companyId} {
      allow get: if isPlatformAdmin() 
                 || isOwner(resource.data.companyOwnerUserId) 
                 || (isSignedIn() && currentUserData().companyId == companyId);
      allow list: if isPlatformAdmin();
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description Company Subscriptions. Uses denormalized ownership for fast access.
     * @path /companies/{companyId}/subscriptions/{subscriptionId}
     * @allow (list) if the Company Owner and the company status is 'Active'.
     * @principle Authorization Independence via Denormalization.
     */
    match /companies/{companyId}/subscriptions/{subscriptionId} {
      allow get: if isPlatformAdmin() 
                 || canOwnerAccess(resource.data.companyOwnerUserId, companyId)
                 || (isSignedIn() && currentUserData().companyId == companyId && isCompanyActive(companyId));
      allow list: if isPlatformAdmin() 
                  || (isSignedIn() && currentUserData().companyId == companyId && isCompanyActive(companyId));
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description Financial transactions for a company.
     * @path /companies/{companyId}/payment_transactions/{transactionId}
     * @allow (get) for Owners and Admins. Viewers typically do not see billing.
     * @principle Denormalized ownership for secure, fast billing access.
     */
    match /companies/{companyId}/payment_transactions/{transactionId} {
      allow get: if isPlatformAdmin() || canOwnerAccess(resource.data.companyOwnerUserId, companyId);
      allow list: if isPlatformAdmin() || (isSignedIn() && isOwner(currentUserData().companyOwnerUserId) && isCompanyActive(companyId));
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description SaaS Platform Profit Tracking.
     * @path /platform_profit_entries/{profitEntryId}
     * @allow (read/write) restricted to Platform Admins.
     * @principle Restricted administrative data.
     */
    match /platform_profit_entries/{profitEntryId} {
      allow get, list: if isPlatformAdmin();
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description Supported platform currencies.
     * @path /currencies/{currencyId}
     * @allow (read) for all authenticated users to see pricing options.
     * @principle Public Read with Admin-Only Writes.
     */
    match /currencies/{currencyId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description Subscription duration cycles (Daily, Monthly, etc.).
     * @path /pricing_cycles/{pricingCycleId}
     * @allow (read) for all authenticated users.
     * @principle Public Read with Admin-Only Writes.
     */
    match /pricing_cycles/{pricingCycleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description Functional modules (Mart, Laundry, etc.).
     * @path /modules/{moduleId}
     * @allow (read) for all authenticated users.
     * @principle Public Read with Admin-Only Writes.
     */
    match /modules/{moduleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description Pricing for modules per cycle.
     * @path /module_pricings/{modulePricingId}
     * @allow (read) for all authenticated users for checkout calculations.
     * @principle Public Read with Admin-Only Writes.
     */
    match /module_pricings/{modulePricingId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isPlatformAdmin();
    }

    /**
     * @description Global platform settings (QR codes, operating currency).
     * @path /platform_configurations/{configId}
     * @allow (read/write) restricted to Platform Admins.
     * @principle Restricted administrative configuration.
     */
    match /platform_configurations/{configId} {
      allow get, list: if isPlatformAdmin();
      allow create, update, delete: if isPlatformAdmin();
    }
  }
}