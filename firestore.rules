rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Venturee Biz SaaS - Security Rules Philosophy
     * 
     * Core Philosophy:
     * This ruleset implements a multi-tenant SaaS security model using a "Company-Centric" approach. 
     * Authorization is strictly enforced based on the relationship between the Authenticated User 
     * and the Company entity.
     * 
     * Data Structure:
     * 1. Platform Admins: Marker documents in /platform_admins for global management.
     * 2. Companies: Root level documents where the document ID is the Owner's Auth UID.
     * 3. Company Users: Top-level documents for employees (e.g., viewers) with denormalized company IDs.
     * 4. Business Data: Products, Customers, and Sales are sub-collections of a Company.
     * 
     * Key Security Decisions:
     * - Authorization Independence: Every document in sub-collections (like SaleItems) contains 
     *   a 'companyId' field. This allows rules to verify access without traversing parent documents.
     * - Owner Access: Access is granted if 'request.auth.uid' matches the '{companyId}' wildcard.
     * - Member Access (Viewer): Access is granted by performing a single lookup on the user's 
     *   own profile (/company_users/{userId}) to verify their 'companyId'.
     * - Prototyping Mode: Schema validation is restricted to relational fields (IDs) to support 
     *   rapid development while maintaining strict access control.
     */

    // --- HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the user has a marker document in the platform_admins collection.
    function isPlatformAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/platform_admins/$(request.auth.uid));
    }

    // Checks if the user is the direct owner of the company (UID matches companyId).
    function isCompanyOwner(companyId) {
      return isSignedIn() && request.auth.uid == companyId;
    }

    // Retrieves the user document from the top-level company_users collection.
    function getCompanyUserDoc() {
      return get(/databases/$(database)/documents/company_users/$(request.auth.uid));
    }

    // Checks if the user is an employee/viewer belonging to the specified company.
    function isCompanyViewer(companyId) {
      return isSignedIn() && getCompanyUserDoc().data.companyId == companyId;
    }

    // Combined check for anyone authorized to access company data.
    function isCompanyMember(companyId) {
      return isCompanyOwner(companyId) || isCompanyViewer(companyId) || isPlatformAdmin();
    }

    // Verifies the document exists and the user is the owner/admin for destructive operations.
    function isExistingOwner(companyId) {
      return (isCompanyOwner(companyId) || isPlatformAdmin()) && resource != null;
    }

    // --- COLLECTION RULES ---

    /**
     * @description Marker documents for global platform administrators.
     * @path /platform_admins/{adminUid}
     * @allow (get) Any authenticated platform admin.
     * @deny (create) Not allowed via client; managed via console/backend.
     * @principle Role-based access control via existence check.
     */
    match /platform_admins/{adminUid} {
      allow get, list: if isPlatformAdmin();
      allow create, update, delete: if false;
    }

    /**
     * @description Root company documents containing core settings and credentials.
     * @path /companies/{companyId}
     * @allow (create) If the user is setting up their own company record.
     * @deny (delete) Only platform admins can delete companies.
     * @principle Ownership-based access; path-uid matching.
     */
    match /companies/{companyId} {
      allow get: if isCompanyMember(companyId);
      allow list: if isPlatformAdmin();
      allow create: if isPlatformAdmin() || (isSignedIn() && request.auth.uid == companyId);
      allow update: if isExistingOwner(companyId);
      allow delete: if isPlatformAdmin() && resource != null;
    }

    /**
     * @description Employee/User accounts associated with a company.
     * @path /company_users/{companyUserId}
     * @allow (get) The user themselves or their company owner.
     * @deny (create) Users cannot create their own accounts unless they match the UID.
     * @principle User-resource ownership and relational validation.
     */
    match /company_users/{companyUserId} {
      allow get: if isSignedIn() && (request.auth.uid == companyUserId || isPlatformAdmin());
      allow list: if isPlatformAdmin();
      allow create: if isSignedIn() && (request.auth.uid == companyUserId || isPlatformAdmin());
      allow update, delete: if isSignedIn() && (request.auth.uid == companyUserId || isPlatformAdmin()) && resource != null;
    }

    /**
     * @description Products and services belonging to a company.
     * @path /companies/{companyId}/products/{productId}
     * @allow (list) All company members (viewers and owners).
     * @deny (update) Company viewers (employees with viewer role).
     * @principle Hierarchical isolation with owner-only writes.
     */
    match /companies/{companyId}/products/{productId} {
      allow get, list: if isCompanyMember(companyId);
      allow create: if (isCompanyOwner(companyId) || isPlatformAdmin()) && request.resource.data.companyId == companyId;
      allow update: if isExistingOwner(companyId) && request.resource.data.companyId == resource.data.companyId;
      allow delete: if isExistingOwner(companyId);
    }

    /**
     * @description Customer CRM records for a company.
     * @path /companies/{companyId}/customers/{customerId}
     * @allow (create) Company owner adding a new customer.
     * @deny (get) User from a different company.
     * @principle Relational integrity enforced by matching path companyId to data field.
     */
    match /companies/{companyId}/customers/{customerId} {
      allow get, list: if isCompanyMember(companyId);
      allow create: if (isCompanyOwner(companyId) || isPlatformAdmin()) && request.resource.data.companyId == companyId;
      allow update: if isExistingOwner(companyId) && request.resource.data.companyId == resource.data.companyId;
      allow delete: if isExistingOwner(companyId);
    }

    /**
     * @description Sales transaction history.
     * @path /companies/{companyId}/saleTransactions/{saleTransactionId}
     * @allow (get) Viewing a specific receipt.
     * @deny (update) Modifying a transaction after it is finalized (if enforced).
     * @principle Denormalized ownership validation on write.
     */
    match /companies/{companyId}/saleTransactions/{saleTransactionId} {
      allow get, list: if isCompanyMember(companyId);
      allow create: if (isCompanyOwner(companyId) || isPlatformAdmin()) && request.resource.data.companyId == companyId;
      allow update: if isExistingOwner(companyId) && request.resource.data.companyId == resource.data.companyId;
      allow delete: if isExistingOwner(companyId);

      /**
       * @description Line items within a specific sale.
       * @path /companies/{companyId}/saleTransactions/{saleTransactionId}/saleItems/{saleItemId}
       * @allow (list) Viewing all items in a sale.
       * @deny (create) Providing a companyId that doesn't match the path.
       * @principle Deeply nested relational integrity and authorization independence.
       */
      match /saleItems/{saleItemId} {
        allow get, list: if isCompanyMember(companyId);
        allow create: if (isCompanyOwner(companyId) || isPlatformAdmin()) && 
                        request.resource.data.companyId == companyId && 
                        request.resource.data.saleTransactionId == saleTransactionId;
        allow update: if isExistingOwner(companyId) && 
                        request.resource.data.companyId == resource.data.companyId &&
                        request.resource.data.saleTransactionId == resource.data.saleTransactionId;
        allow delete: if isExistingOwner(companyId);
      }
    }
  }
}